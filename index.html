<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµæ¢å®šä»·åˆ†æå·¥å…· - ç²¾ç®€ç‰ˆ</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #1e293b;
            --border: #e2e8f0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        /* å¤´éƒ¨ */
        .header {
            background: white;
            border-radius: 16px;
            padding: 24px 32px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--success));
        }
        
        .logo-area {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 8px;
        }
        
        .logo {
            font-size: 32px;
            color: var(--primary);
        }
        
        .title {
            color: var(--dark);
            font-size: 24px;
            font-weight: 700;
        }
        
        .subtitle {
            color: #64748b;
            font-size: 14px;
        }
        
        /* SKUç®¡ç† */
        .sku-management {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border);
            margin-bottom: 24px;
            position: relative;
        }
        
        .sku-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .sku-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .sku-table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .sku-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1300px;
        }
        
        .sku-table th {
            background: #f1f5f9;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            font-size: 13px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .sku-table td {
            padding: 10px 16px;
            border-bottom: 1px solid var(--border);
            color: #475569;
            font-size: 13px;
            transition: background-color 0.2s;
        }
        
        .sku-table tr:hover {
            background: #f8fafc;
        }
        
        .sku-table input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.2s;
            background: white;
        }
        
        .sku-table input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }
        
        .sku-table input:focus + .enter-hint {
            opacity: 1;
        }
        
        .sku-actions {
            display: flex;
            gap: 6px;
        }
        
        .sku-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .sku-btn.add {
            background: var(--primary);
            color: white;
        }
        
        .sku-btn.remove {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .sku-btn.calc {
            background: var(--success);
            color: white;
        }
        
        /* æŠ˜æ‰£ç±»å‹åˆ‡æ¢ */
        .discount-type {
            display: flex;
            background: #e2e8f0;
            border-radius: 6px;
            padding: 4px;
            margin-bottom: 8px;
        }
        
        .type-btn {
            flex: 1;
            padding: 4px 6px;
            text-align: center;
            font-size: 11px;
            font-weight: 500;
            color: #64748b;
            background: transparent;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .type-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        /* æŠ˜æ‰£é‡‘é¢é¢„è§ˆ */
        .discount-preview {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .discount-preview-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
        }
        
        .discount-preview-label {
            color: #64748b;
        }
        
        .discount-preview-value {
            font-weight: 600;
        }
        
        .discount-preview-value.primary {
            color: var(--primary);
        }
        
        .discount-preview-value.warning {
            color: var(--warning);
        }
        
        .discount-preview-value.danger {
            color: var(--danger);
        }
        
        .discount-preview-total {
            border-top: 1px solid var(--border);
            padding-top: 4px;
            margin-top: 2px;
            font-weight: 600;
            font-size: 12px;
            color: var(--dark);
        }
        
        /* æˆæœ¬å‚æ•°é¢æ¿ */
        .cost-panel {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border);
            position: relative;
        }
        
        .section-title {
            color: var(--dark);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-label {
            display: block;
            color: #475569;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .input-label .info-icon {
            color: #94a3b8;
            cursor: help;
            font-size: 12px;
        }
        
        .input-wrapper {
            position: relative;
        }
        
        .input-wrapper input {
            width: 100%;
            padding: 10px 36px 10px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            background: white;
        }
        
        .input-wrapper input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .currency {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-weight: 500;
        }
        
        .input-tip {
            color: #94a3b8;
            font-size: 12px;
            margin-top: 6px;
        }
        
        /* æˆæœ¬å‚æ•°é‡‘é¢é¢„è§ˆ */
        .cost-preview {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            margin-top: 20px;
        }
        
        .cost-preview-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .cost-preview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        @media (max-width: 768px) {
            .cost-preview-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .cost-preview-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .cost-preview-label {
            font-size: 14px;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .cost-preview-value {
            font-size: 16px;
            font-weight: 600;
        }
        
        .cost-preview-value.platform {
            color: #3b82f6;
        }
        
        .cost-preview-value.kol {
            color: #8b5cf6;
        }
        
        .cost-preview-value.return {
            color: #f59e0b;
        }
        
        .cost-preview-value.other {
            color: #10b981;
        }
        
        .cost-preview-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            margin-top: 12px;
            background: #f1f5f9;
            border-radius: 8px;
            border: 2px solid var(--primary);
        }
        
        .cost-preview-total-label {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .cost-preview-total-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }
        
        /* å‚æ•°ç½‘æ ¼ */
        .params-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }
        
        @media (max-width: 1200px) {
            .params-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .params-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* æŒ‰é’® */
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-height: 44px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
        }
        
        .btn-secondary {
            background: white;
            color: var(--dark);
            border: 2px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--light);
            border-color: var(--primary);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #34d399 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #fbbf24 100%);
            color: white;
        }
        
        /* å ä½ç¬¦æ ·å¼ */
        .placeholder {
            color: #94a3b8;
            font-style: italic;
        }
        
        /* åŠ¨ç”» */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        /* é”™è¯¯æç¤º */
        .error-message {
            background: #fef2f2;
            border: 2px solid #fee2e2;
            color: #dc2626;
            padding: 10px 16px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* é€šçŸ¥ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background: var(--success);
            color: white;
        }
        
        .notification.error {
            background: #ef4444;
        }
        
        .notification.warning {
            background: #f59e0b;
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading {
            opacity: 0.7;
            pointer-events: none;
            position: relative;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0,0,0,0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        /* å›è½¦æç¤º */
        .enter-hint {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        
        .input-with-hint {
            position: relative;
        }
        
        /* è¡¨æ ¼å•å…ƒæ ¼æ ·å¼ */
        .table-cell-input {
            position: relative;
        }
        
        .discount-input-group {
            margin-bottom: 8px;
        }
        
        /* ç©ºçŠ¶æ€æç¤º */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #94a3b8;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-state-text {
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .empty-state-subtext {
            font-size: 12px;
            color: #cbd5e1;
        }
        
        /* æˆæœ¬é¢„è§ˆå›¾æ ‡ */
        .cost-icon {
            font-size: 16px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        .platform-icon {
            background: #dbeafe;
            color: #3b82f6;
        }
        
        .kol-icon {
            background: #ede9fe;
            color: #8b5cf6;
        }
        
        .return-icon {
            background: #fef3c7;
            color: #f59e0b;
        }
        
        .other-icon {
            background: #d1fae5;
            color: #10b981;
        }
        
        /* æ•°æ®ç»Ÿè®¡ */
        .stats-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-top: 1px solid var(--border);
            margin-top: 12px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .stat-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .stat-label {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
        }
        
        /* è‡ªåŠ¨ä¿å­˜æç¤º */
        .save-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s;
            z-index: 100;
        }
        
        .save-status.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* é”®ç›˜å¿«æ·é”®æç¤º */
        .keyboard-hint {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: #94a3b8;
            font-size: 11px;
        }
        
        /* æ‰¹é‡ç¼–è¾‘é¢æ¿ */
        .batch-edit-panel {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            display: none;
        }
        
        .batch-edit-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .batch-edit-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }
        
        @media (max-width: 1200px) {
            .batch-edit-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .batch-edit-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .batch-edit-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            justify-content: flex-end;
        }
        
        /* ä»·æ ¼åŒºé—´æç¤º */
        .price-range {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 2px;
        }
        
        .price-range.low {
            color: var(--success);
        }
        
        .price-range.high {
            color: var(--danger);
        }
        
        /* åˆ©æ¶¦é¢œè‰²æ ·å¼ */
        .profit-high {
            color: var(--success);
            font-weight: 700;
        }
        
        .profit-medium {
            color: var(--warning);
            font-weight: 700;
        }
        
        .profit-low {
            color: #f59e0b;
            font-weight: 700;
        }
        
        .profit-very-low {
            color: #f97316;
            font-weight: 700;
        }
        
        .profit-negative {
            color: var(--danger);
            font-weight: 700;
        }
        
        .profit-positive {
            color: var(--primary);
            font-weight: 600;
        }
        
        /* è¡¨æ ¼ä¸­çš„åˆ©æ¶¦é¢œè‰² */
        .sku-gross-profit.profit-high,
        .sku-net-profit.profit-high {
            color: var(--success);
            font-weight: 600;
        }
        
        .sku-gross-profit.profit-medium,
        .sku-net-profit.profit-medium {
            color: var(--warning);
            font-weight: 600;
        }
        
        .sku-gross-profit.profit-low,
        .sku-net-profit.profit-low {
            color: #f59e0b;
            font-weight: 600;
        }
        
        .sku-gross-profit.profit-very-low,
        .sku-net-profit.profit-very-low {
            color: #f97316;
            font-weight: 600;
        }
        
        .sku-gross-profit.profit-negative,
        .sku-net-profit.profit-negative {
            color: var(--danger);
            font-weight: 600;
        }
        
        .sku-gross-margin.profit-high,
        .sku-net-margin.profit-high {
            color: var(--success);
            font-weight: 600;
        }
        
        .sku-gross-margin.profit-medium,
        .sku-net-margin.profit-medium {
            color: var(--warning);
            font-weight: 600;
        }
        
        .sku-gross-margin.profit-low,
        .sku-net-margin.profit-low {
            color: #f59e0b;
            font-weight: 600;
        }
        
        .sku-gross-margin.profit-very-low,
        .sku-net-margin.profit-very-low {
            color: #f97316;
            font-weight: 600;
        }
        
        .sku-gross-margin.profit-negative,
        .sku-net-margin.profit-negative {
            color: var(--danger);
            font-weight: 600;
        }
        
        .sku-cost-margin.profit-high {
            color: #8b5cf6;
            font-weight: 600;
        }
        
        .sku-cost-margin.profit-medium {
            color: var(--success);
            font-weight: 600;
        }
        
        .sku-cost-margin.profit-low {
            color: var(--warning);
            font-weight: 600;
        }
        
        .sku-cost-margin.profit-very-low {
            color: #f97316;
            font-weight: 600;
        }
        
        .sku-cost-margin.profit-negative {
            color: var(--danger);
            font-weight: 600;
        }
        
        .sku-final-price.profit-positive {
            color: var(--primary);
            font-weight: 600;
        }
        
        .sku-unit-price.profit-positive {
            color: #8b5cf6;
            font-weight: 600;
        }
        
        /* æ¯ç“¶æ•°é‡è¾“å…¥æ¡†æ ·å¼ */
        .bottles-input {
            width: 70px !important;
            text-align: center;
        }
        
        /* å¿«é€Ÿæ“ä½œé¢æ¿ */
        .quick-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .quick-action-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: #475569;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .quick-action-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <div class="logo-area">
                <div class="logo">ğŸ’°</div>
                <div>
                    <h1 class="title">çµæ¢å®šä»·åˆ†æå·¥å…·</h1>
                    <p class="subtitle">å¤šSKUæˆæœ¬æ ¸å¯¹ Â· åˆ©æ¶¦è®¡ç®— Â· å•ä»·åˆ†æ</p>
                </div>
            </div>
            <div class="keyboard-hint">
                ğŸ’¡ å¿«æ·é”®: Enterä¿å­˜å¹¶è®¡ç®—å½“å‰è¡Œ | Ctrl+Sä¿å­˜æ•°æ® | Ctrl+Zæ’¤é”€
            </div>
        </div>
        
        <!-- SKUç®¡ç† -->
        <div class="sku-management fade-in">
            <div class="sku-header">
                <div class="section-title">ğŸ“¦ SKUå®šä»·ç®¡ç†</div>
                <div class="sku-controls">
                    <button class="btn sku-btn add" id="addSKU">
                        â• æ·»åŠ SKU
                    </button>
                    <button class="btn btn-primary" id="calculateAll">
                        ğŸš€ æ‰¹é‡è®¡ç®—
                    </button>
                    <button class="btn btn-secondary" id="toggleBatchEdit">
                        ğŸ› ï¸ æ‰¹é‡ç¼–è¾‘
                    </button>
                </div>
            </div>
            
            <!-- æ‰¹é‡ç¼–è¾‘é¢æ¿ -->
            <div class="batch-edit-panel" id="batchEditPanel">
                <div class="batch-edit-title">
                    <span>ğŸ› ï¸ æ‰¹é‡ç¼–è¾‘é€‰ä¸­çš„ <span id="selectedCount">0</span> ä¸ªSKU</span>
                    <button class="btn btn-secondary" id="closeBatchEdit">âœ•</button>
                </div>
                <div class="batch-edit-grid">
                    <div class="input-group">
                        <label class="input-label">
                            ç»Ÿä¸€æˆæœ¬ä»·
                            <span class="info-icon" title="ä¸ºæ‰€æœ‰é€‰ä¸­çš„SKUè®¾ç½®ç›¸åŒçš„æˆæœ¬ä»·">?</span>
                        </label>
                        <div class="input-wrapper">
                            <input type="number" id="batchCost" min="0" step="0.01" placeholder="è¾“å…¥æˆæœ¬ä»·">
                            <span class="currency">å…ƒ</span>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">
                            ç»Ÿä¸€ç›®æ ‡å”®ä»·
                            <span class="info-icon" title="ä¸ºæ‰€æœ‰é€‰ä¸­çš„SKUè®¾ç½®ç›¸åŒçš„ç›®æ ‡å”®ä»·">?</span>
                        </label>
                        <div class="input-wrapper">
                            <input type="number" id="batchTargetPrice" min="0" step="0.01" placeholder="è¾“å…¥ç›®æ ‡å”®ä»·">
                            <span class="currency">å…ƒ</span>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">
                            å•å“ç›´é™æ¯”ä¾‹
                            <span class="info-icon" title="ä¸ºæ‰€æœ‰é€‰ä¸­çš„SKUè®¾ç½®ç›¸åŒçš„å•å“ç›´é™æ¯”ä¾‹">?</span>
                        </label>
                        <div class="input-wrapper">
                            <input type="number" id="batchDirectDiscount" min="0" max="100" step="0.1" placeholder="è¾“å…¥ç›´é™æ¯”ä¾‹">
                            <span class="currency">%</span>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">
                            ä¼˜æƒ åˆ¸é‡‘é¢
                            <span class="info-icon" title="ä¸ºæ‰€æœ‰é€‰ä¸­çš„SKUè®¾ç½®ç›¸åŒçš„ä¼˜æƒ åˆ¸é‡‘é¢">?</span>
                        </label>
                        <div class="input-wrapper">
                            <input type="number" id="batchCouponDiscount" min="0" step="0.01" placeholder="è¾“å…¥ä¼˜æƒ åˆ¸é‡‘é¢">
                            <span class="currency">å…ƒ</span>
                        </div>
                    </div>
                </div>
                <div class="batch-edit-actions">
                    <button class="btn btn-secondary" id="applyBatch">åº”ç”¨æ›´æ”¹</button>
                    <button class="btn btn-primary" id="applyAndCalculate">åº”ç”¨å¹¶è®¡ç®—</button>
                </div>
            </div>
            
            <div class="sku-table-container">
                <table class="sku-table">
                    <thead>
                        <tr>
                            <th width="40">
                                <input type="checkbox" id="selectAll">
                            </th>
                            <th width="80">åºå·</th>
                            <th width="100">æˆæœ¬ä»·(å…ƒ)</th>
                            <th width="80">æ¯SKUç“¶æ•°</th>
                            <th width="100">ç›®æ ‡å”®ä»·(å…ƒ)</th>
                            <th width="200">å•å“ç›´é™</th>
                            <th width="200">ä¼˜æƒ åˆ¸</th>
                            <th width="100">æœ€ç»ˆå”®ä»·(å…ƒ)</th>
                            <th width="100">æ¯ç“¶å•ä»·(å…ƒ)</th>
                            <th width="90">æ¯›åˆ©(å…ƒ)</th>
                            <th width="80">æ¯›åˆ©ç‡</th>
                            <th width="80">æˆæœ¬æ¯›åˆ©ç‡</th>
                            <th width="90">å‡€åˆ©(å…ƒ)</th>
                            <th width="80">å‡€åˆ©ç‡</th>
                            <th width="70">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="skuTableBody">
                        <!-- åˆå§‹ä¸ºç©º -->
                    </tbody>
                </table>
                <!-- ç©ºçŠ¶æ€æç¤º -->
                <div id="emptyState" class="empty-state" style="display: block;">
                    <div class="empty-state-icon">ğŸ“¦</div>
                    <div class="empty-state-text">æš‚æ— SKUæ•°æ®</div>
                    <div class="empty-state-subtext">ç‚¹å‡»"æ·»åŠ SKU"æŒ‰é’®å¼€å§‹æ·»åŠ ï¼Œæˆ–ç‚¹å‡»"æ·»åŠ ç¤ºä¾‹"æŸ¥çœ‹ç¤ºä¾‹æ•°æ®</div>
                </div>
            </div>
            
            <!-- æ•°æ®ç»Ÿè®¡ -->
            <div class="stats-bar" id="statsBar" style="display: none;">
                <div class="stat-item">
                    <div class="stat-value" id="statsTotalSKU">0</div>
                    <div class="stat-label">SKUæ€»æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statsCalculated">0</div>
                    <div class="stat-label">å·²è®¡ç®—</div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                <div style="font-size: 14px; color: #64748b;">
                    æ€»è®¡ <span id="skuCount" style="font-weight: 700; color: var(--primary);">0</span> ä¸ªSKU | 
                    å·²è®¡ç®— <span id="calculatedCount" style="font-weight: 700; color: var(--success);">0</span> ä¸ª
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" id="addSampleSKUs">
                        ğŸ“‹ æ·»åŠ ç¤ºä¾‹
                    </button>
                    <button class="btn btn-success" id="exportData">
                        ğŸ“¤ å¯¼å‡ºæ•°æ®
                    </button>
                    <button class="btn btn-warning" id="saveData">
                        ğŸ’¾ ä¿å­˜æ•°æ®
                    </button>
                    <button class="btn" id="loadData" style="background: #8b5cf6; color: white;">
                        ğŸ“‚ åŠ è½½æ•°æ®
                    </button>
                </div>
            </div>
        </div>
        
        <!-- æˆæœ¬å‚æ•°é¢æ¿ -->
        <div class="cost-panel fade-in">
            <div class="section-title">ğŸ“Š æˆæœ¬å‚æ•°é…ç½®</div>
            <p style="color: #64748b; font-size: 14px; margin-bottom: 16px;">è®¾ç½®å¹³å°ä½£é‡‘ã€è¾¾äººä½£é‡‘ã€é€€è´§ç‡å’Œå…¶ä»–æˆæœ¬ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—å„é¡¹æˆæœ¬çš„å…·ä½“é‡‘é¢</p>
            
            <div class="params-grid">
                <div class="input-group">
                    <label class="input-label">
                        å¹³å°ä½£é‡‘æ¯”ä¾‹
                        <span class="info-icon" title="ç”µå•†å¹³å°æ”¶å–çš„äº¤æ˜“ä½£é‡‘ï¼Œé€šå¸¸ä¸ºé”€å”®é¢çš„5-10%">?</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="number" id="platformFee" value="5" min="0" max="50" step="0.1" placeholder="ä¾‹å¦‚ï¼š5">
                        <span class="currency">%</span>
                    </div>
                    <div class="input-tip">é€šå¸¸5-10%ï¼Œå»ºè®®å€¼: 5%</div>
                    <div class="price-range low">è¡Œä¸šåŒºé—´: 3-15%</div>
                </div>
                
                <div class="input-group">
                    <label class="input-label">
                        è¾¾äººä½£é‡‘æ¯”ä¾‹
                        <span class="info-icon" title="è¾¾äºº/ä¸»æ’­å¸¦è´§çš„ä½£é‡‘æ¯”ä¾‹ï¼Œé€šå¸¸ä¸ºé”€å”®é¢çš„20-30%">?</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="number" id="kolFee" value="20" min="0" max="50" step="0.1" placeholder="ä¾‹å¦‚ï¼š20">
                        <span class="currency">%</span>
                    </div>
                    <div class="input-tip">è¾¾äººå¸¦è´§ä½£é‡‘</div>
                    <div class="price-range">è¡Œä¸šåŒºé—´: 15-40%</div>
                </div>
                
                <div class="input-group">
                    <label class="input-label">
                        é€€è´§ç‡é¢„ä¼°
                        <span class="info-icon" title="é¢„è®¡çš„å•†å“é€€è´§ç‡ï¼Œè¡Œä¸šå¹³å‡5-15%">?</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="number" id="returnRate" value="5" min="0" max="50" step="0.1" placeholder="ä¾‹å¦‚ï¼š5">
                        <span class="currency">%</span>
                    </div>
                    <div class="input-tip">è¡Œä¸šå¹³å‡5-15%</div>
                    <div class="price-range low">è¡Œä¸šåŒºé—´: 2-20%</div>
                </div>
                
                <div class="input-group">
                    <label class="input-label">
                        å…¶ä»–æˆæœ¬
                        <span class="info-icon" title="åŒ…è£…ã€ç‰©æµã€äººå·¥ç­‰é¢å¤–æˆæœ¬">?</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="number" id="otherCost" value="5" min="0" step="0.01" placeholder="åŒ…è£…ã€è¿è´¹ç­‰">
                        <span class="currency">å…ƒ</span>
                    </div>
                    <div class="input-tip">æ¯ä»¶å•†å“é¢å¤–æˆæœ¬</div>
                    <div class="price-range">é€šå¸¸: 3-10å…ƒ</div>
                </div>
            </div>
            
            <!-- æˆæœ¬é‡‘é¢é¢„è§ˆ -->
            <div class="cost-preview" id="costPreview">
                <div class="cost-preview-title">
                    <span>ğŸ“‹ æˆæœ¬æ˜ç»†ï¼ˆåŸºäºå‚è€ƒå”®ä»·ï¼‰</span>
                </div>
                
                <div class="cost-preview-grid">
                    <div class="cost-preview-item">
                        <div class="cost-preview-label">
                            <div class="cost-icon platform-icon">ğŸ¢</div>
                            <span>å¹³å°ä½£é‡‘</span>
                        </div>
                        <div class="cost-preview-value platform" id="platformCost">0.00 å…ƒ</div>
                    </div>
                    
                    <div class="cost-preview-item">
                        <div class="cost-preview-label">
                            <div class="cost-icon kol-icon">ğŸŒŸ</div>
                            <span>è¾¾äººä½£é‡‘</span>
                        </div>
                        <div class="cost-preview-value kol" id="kolCost">0.00 å…ƒ</div>
                    </div>
                    
                    <div class="cost-preview-item">
                        <div class="cost-preview-label">
                            <div class="cost-icon return-icon">ğŸ“¦</div>
                            <span>é€€è´§æŸè€—</span>
                        </div>
                        <div class="cost-preview-value return" id="returnCost">0.00 å…ƒ</div>
                    </div>
                    
                    <div class="cost-preview-item">
                        <div class="cost-preview-label">
                            <div class="cost-icon other-icon">ğŸ“¦</div>
                            <span>å…¶ä»–æˆæœ¬</span>
                        </div>
                        <div class="cost-preview-value other" id="otherCostAmount">0.00 å…ƒ</div>
                    </div>
                </div>
                
                <div class="cost-preview-total">
                    <div class="cost-preview-total-label">æ¯ä»¶å•†å“æ€»é¢å¤–æˆæœ¬</div>
                    <div class="cost-preview-total-value" id="totalAdditionalCost">0.00 å…ƒ</div>
                </div>
                
                <div style="margin-top: 12px; font-size: 12px; color: #94a3b8;">
                    <div>å‚è€ƒå”®ä»·ï¼š<span id="referencePrice" style="font-weight: 600; color: var(--primary);">0.00 å…ƒ</span></div>
                    <div>è¯´æ˜ï¼šæˆæœ¬æ˜ç»†åŸºäºå‚è€ƒå”®ä»·è®¡ç®—ï¼Œå‚è€ƒå”®ä»·ä¸ºå·²è®¡ç®—SKUçš„å¹³å‡æœ€ç»ˆå”®ä»·</div>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-primary" id="applyToAll">
                    ğŸ”„ åº”ç”¨åˆ°æ‰€æœ‰SKU
                </button>
                <button class="btn btn-secondary" id="resetConfig">
                    ğŸ”„ é‡ç½®é…ç½®
                </button>
                <button class="btn btn-warning" id="updateCostPreview">
                    ğŸ” æ›´æ–°æˆæœ¬é¢„è§ˆ
                </button>
                <button class="btn" id="savePreset" style="background: #8b5cf6; color: white;">
                    ğŸ’¾ ä¿å­˜é¢„è®¾
                </button>
                <button class="btn" id="loadPreset" style="background: #f59e0b; color: white;">
                    ğŸ“‚ åŠ è½½é¢„è®¾
                </button>
            </div>
        </div>
    </div>

    <!-- è‡ªåŠ¨ä¿å­˜æç¤º -->
    <div class="save-status" id="saveStatus">æ•°æ®å·²ä¿å­˜</div>

    <!-- æ–‡ä»¶è¾“å…¥ï¼ˆéšè—ï¼‰ -->
    <input type="file" id="fileInput" accept=".json,.xlsx,.xls,.csv" style="display: none;">
    <input type="file" id="presetInput" accept=".json" style="display: none;">

    <script>
        // å…¨å±€å˜é‡
        let skuList = [];
        let inputTimeout = null; // é˜²æŠ–è®¡æ—¶å™¨
        let referencePrice = 0; // å‚è€ƒå”®ä»·ï¼Œç”¨äºæˆæœ¬é¢„è§ˆ
        let undoStack = []; // æ’¤é”€æ ˆ
        let redoStack = []; // é‡åšæ ˆ
        let autoSaveTimer = null; // è‡ªåŠ¨ä¿å­˜è®¡æ—¶å™¨
        let isBatchEditOpen = false; // æ‰¹é‡ç¼–è¾‘é¢æ¿çŠ¶æ€
        let selectedSKUs = new Set(); // é€‰ä¸­çš„SKU IDé›†åˆ
        
        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            // åŠ è½½æœ¬åœ°å­˜å‚¨çš„æ•°æ®
            loadFromLocalStorage();
            // æ·»åŠ ä¸€ä¸ªç©ºçš„SKUï¼Œè®©ç”¨æˆ·å¯ä»¥ç«‹å³å¼€å§‹å¡«å†™
            if (skuList.length === 0) {
                addEmptySKU();
            } else {
                updateSKUTable();
            }
            
            // åˆå§‹åŒ–æˆæœ¬å‚æ•°é¢„è§ˆ
            updateCostPreview();
            
            // è®¾ç½®è‡ªåŠ¨ä¿å­˜
            setupAutoSave();
            
            // è®¾ç½®é”®ç›˜å¿«æ·é”®
            setupKeyboardShortcuts();
        });
        
        // è®¾ç½®é”®ç›˜å¿«æ·é”®
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl+S ä¿å­˜æ•°æ®
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    saveToLocalStorage();
                    showSaveStatus('æ•°æ®å·²ä¿å­˜');
                }
                
                // Ctrl+Z æ’¤é”€
                if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                    e.preventDefault();
                    undo();
                }
                
                // Ctrl+Y æˆ– Ctrl+Shift+Z é‡åš
                if ((e.ctrlKey && e.key === 'y') || ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'z')) {
                    e.preventDefault();
                    redo();
                }
                
                // Ctrl+A å…¨é€‰
                if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
                    // å¦‚æœç„¦ç‚¹åœ¨è¡¨æ ¼å†…ï¼Œé˜²æ­¢å…¨é€‰æ•´ä¸ªé¡µé¢
                    if (document.activeElement.tagName !== 'INPUT' || 
                        !document.activeElement.classList.contains('sku-cost') &&
                        !document.activeElement.classList.contains('sku-target-price')) {
                        e.preventDefault();
                        selectAllSKUs();
                    }
                }
            });
        }
        
        // è®¾ç½®è‡ªåŠ¨ä¿å­˜
        function setupAutoSave() {
            // æ¯30ç§’è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡
            autoSaveTimer = setInterval(() => {
                if (skuList.length > 0) {
                    saveToLocalStorage();
                    showSaveStatus('æ•°æ®å·²è‡ªåŠ¨ä¿å­˜');
                }
            }, 30000);
        }
        
        // æ˜¾ç¤ºä¿å­˜çŠ¶æ€
        function showSaveStatus(message) {
            const statusEl = document.getElementById('saveStatus');
            statusEl.textContent = message;
            statusEl.classList.add('show');
            
            setTimeout(() => {
                statusEl.classList.remove('show');
            }, 2000);
        }
        
        // ä¿å­˜çŠ¶æ€åˆ°æ’¤é”€æ ˆ
        function saveStateToUndoStack() {
            // ä¿å­˜å½“å‰çŠ¶æ€åˆ°æ’¤é”€æ ˆ
            undoStack.push(JSON.stringify(skuList));
            
            // é™åˆ¶æ’¤é”€æ ˆå¤§å°
            if (undoStack.length > 20) {
                undoStack.shift();
            }
            
            // æ¸…ç©ºé‡åšæ ˆ
            redoStack = [];
        }
        
        // æ’¤é”€æ“ä½œ
        function undo() {
            if (undoStack.length > 0) {
                // å½“å‰çŠ¶æ€ä¿å­˜åˆ°é‡åšæ ˆ
                redoStack.push(JSON.stringify(skuList));
                
                // æ¢å¤ä¸Šä¸€ä¸ªçŠ¶æ€
                const prevState = undoStack.pop();
                skuList = JSON.parse(prevState);
                
                updateSKUTable();
                updateCostPreview();
                
                showSaveStatus('å·²æ’¤é”€');
            }
        }
        
        // é‡åšæ“ä½œ
        function redo() {
            if (redoStack.length > 0) {
                // å½“å‰çŠ¶æ€ä¿å­˜åˆ°æ’¤é”€æ ˆ
                undoStack.push(JSON.stringify(skuList));
                
                // æ¢å¤ä¸‹ä¸€ä¸ªçŠ¶æ€
                const nextState = redoStack.pop();
                skuList = JSON.parse(nextState);
                
                updateSKUTable();
                updateCostPreview();
                
                showSaveStatus('å·²é‡åš');
            }
        }
        
        // å…¨é€‰SKU
        function selectAllSKUs() {
            const allCheckboxes = document.querySelectorAll('.sku-checkbox');
            const selectAllCheckbox = document.getElementById('selectAll');
            
            if (selectAllCheckbox.checked) {
                // é€‰ä¸­æ‰€æœ‰
                allCheckboxes.forEach(checkbox => {
                    checkbox.checked = true;
                    selectedSKUs.add(parseInt(checkbox.dataset.id));
                });
            } else {
                // å–æ¶ˆæ‰€æœ‰
                allCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    selectedSKUs.delete(parseInt(checkbox.dataset.id));
                });
            }
            
            updateSelectedCount();
            toggleBatchEditPanel();
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æˆæœ¬å‚æ•°è¾“å…¥äº‹ä»¶ - ä½¿ç”¨é˜²æŠ–
            const costInputIds = ['platformFee', 'kolFee', 'returnRate', 'otherCost'];
            costInputIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', debounce(updateCostPreview, 500));
                }
            });
            
            // æŒ‰é’®äº‹ä»¶
            document.getElementById('applyToAll').addEventListener('click', applyToAllSKUs);
            document.getElementById('resetConfig').addEventListener('click', resetConfig);
            document.getElementById('updateCostPreview').addEventListener('click', updateCostPreview);
            document.getElementById('addSKU').addEventListener('click', addSKU);
            document.getElementById('addSampleSKUs').addEventListener('click', addSampleSKUs);
            document.getElementById('calculateAll').addEventListener('click', calculateAllSKUs);
            document.getElementById('exportData').addEventListener('click', exportSKUData);
            document.getElementById('saveData').addEventListener('click', saveToLocalStorage);
            document.getElementById('loadData').addEventListener('click', loadFromLocalStorage);
            document.getElementById('savePreset').addEventListener('click', savePreset);
            document.getElementById('loadPreset').addEventListener('click', loadPreset);
            
            // æ–°å¢åŠŸèƒ½æŒ‰é’®
            document.getElementById('toggleBatchEdit').addEventListener('click', toggleBatchEditPanel);
            document.getElementById('closeBatchEdit').addEventListener('click', toggleBatchEditPanel);
            document.getElementById('applyBatch').addEventListener('click', applyBatchEdit);
            document.getElementById('applyAndCalculate').addEventListener('click', () => {
                applyBatchEdit();
                calculateAllSKUs();
            });
            
            // å…¨é€‰å¤é€‰æ¡†
            document.getElementById('selectAll').addEventListener('change', selectAllSKUs);
            
            // æ–‡ä»¶è¾“å…¥äº‹ä»¶
            document.getElementById('fileInput').addEventListener('change', handleFileImport);
            document.getElementById('presetInput').addEventListener('change', handlePresetImport);
        }
        
        // é˜²æŠ–å‡½æ•°ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        function debounce(func, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        }
        
        // æ›´æ–°æˆæœ¬é¢„è§ˆ
        function updateCostPreview() {
            // è·å–æˆæœ¬å‚æ•°
            const platformFeePercent = parseFloat(document.getElementById('platformFee').value) / 100 || 0;
            const kolFeePercent = parseFloat(document.getElementById('kolFee').value) / 100 || 0;
            const returnRatePercent = parseFloat(document.getElementById('returnRate').value) / 100 || 0;
            const otherCost = parseFloat(document.getElementById('otherCost').value) || 0;
            
            // è®¡ç®—å‚è€ƒå”®ä»·ï¼ˆä½¿ç”¨å·²è®¡ç®—SKUçš„å¹³å‡æœ€ç»ˆå”®ä»·ï¼‰
            let totalFinalPrice = 0;
            let calculatedSKUCount = 0;
            
            skuList.forEach(sku => {
                if (sku.finalPrice > 0) {
                    totalFinalPrice += sku.finalPrice;
                    calculatedSKUCount++;
                }
            });
            
            if (calculatedSKUCount > 0) {
                referencePrice = totalFinalPrice / calculatedSKUCount;
            } else {
                // å¦‚æœæ²¡æœ‰å·²è®¡ç®—çš„SKUï¼Œä½¿ç”¨é»˜è®¤å‚è€ƒå”®ä»·
                referencePrice = 100; // é»˜è®¤100å…ƒä½œä¸ºå‚è€ƒ
            }
            
            // æ›´æ–°å‚è€ƒå”®ä»·æ˜¾ç¤º
            document.getElementById('referencePrice').textContent = referencePrice.toFixed(2) + ' å…ƒ';
            
            // è®¡ç®—å„é¡¹æˆæœ¬é‡‘é¢
            const platformCost = referencePrice * platformFeePercent;
            const kolCost = referencePrice * kolFeePercent;
            const returnCost = referencePrice * returnRatePercent;
            const otherCostAmount = otherCost;
            const totalAdditionalCost = platformCost + kolCost + returnCost + otherCostAmount;
            
            // æ›´æ–°æˆæœ¬é‡‘é¢æ˜¾ç¤º
            document.getElementById('platformCost').textContent = platformCost.toFixed(2) + ' å…ƒ';
            document.getElementById('kolCost').textContent = kolCost.toFixed(2) + ' å…ƒ';
            document.getElementById('returnCost').textContent = returnCost.toFixed(2) + ' å…ƒ';
            document.getElementById('otherCostAmount').textContent = otherCostAmount.toFixed(2) + ' å…ƒ';
            document.getElementById('totalAdditionalCost').textContent = totalAdditionalCost.toFixed(2) + ' å…ƒ';
            
            // æ›´æ–°æ‰€æœ‰SKUçš„è®¡ç®—ï¼ˆå¦‚æœæˆæœ¬å‚æ•°å˜åŒ–ï¼‰
            if (calculatedSKUCount > 0) {
                calculateAllSKUs();
            }
        }
        
        // æ·»åŠ ä¸€ä¸ªç©ºçš„SKU
        function addEmptySKU() {
            saveStateToUndoStack();
            
            const newId = skuList.length > 0 ? Math.max(...skuList.map(sku => sku.id)) + 1 : 1;
            skuList.push({
                id: newId,
                cost: 0,
                bottles: 1, // æ¯SKUç“¶æ•°ï¼Œé»˜è®¤ä¸º1
                targetPrice: 0,
                directDiscountType: 'percent',
                directDiscountValue: 0,
                couponDiscountType: 'amount', // é»˜è®¤ä¼˜æƒ åˆ¸ç±»å‹ä¸ºå…ƒ
                couponDiscountValue: 0,
                directDiscount: 0,
                couponAmount: 0,
                finalPrice: 0,
                unitPrice: 0, // æ¯ç“¶å•ä»·
                grossProfit: 0,
                grossMargin: 0,
                costMargin: 0,
                netProfit: 0,
                netMargin: 0,
                // æ–°å¢å­—æ®µï¼šæŠ˜æ‰£é¢„è§ˆ
                directDiscountPreview: 0,
                couponDiscountPreview: 0,
                priceAfterDirect: 0,
                priceAfterAll: 0,
                // æ–°å¢å­—æ®µï¼šåˆ›å»ºæ—¶é—´
                createdAt: new Date().toISOString(),
                // æ–°å¢å­—æ®µï¼šæ˜¯å¦é€‰ä¸­
                selected: false
            });
            
            updateSKUTable();
            // éšè—ç©ºçŠ¶æ€æç¤º
            document.getElementById('emptyState').style.display = 'none';
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveToLocalStorage();
        }
        
        // æ·»åŠ ç¤ºä¾‹SKUæ•°æ®
        function addSampleSKUs() {
            saveStateToUndoStack();
            
            const sampleSKUs = [
                { id: 1, cost: 85, bottles: 1, targetPrice: 199, directDiscountType: 'percent', directDiscountValue: 10, couponDiscountType: 'amount', couponDiscountValue: 5 },
                { id: 2, cost: 120, bottles: 1, targetPrice: 299, directDiscountType: 'percent', directDiscountValue: 15, couponDiscountType: 'amount', couponDiscountValue: 10 },
                { id: 3, cost: 200, bottles: 1, targetPrice: 499, directDiscountType: 'amount', directDiscountValue: 50, couponDiscountType: 'amount', couponDiscountValue: 20 },
                { id: 4, cost: 50, bottles: 2, targetPrice: 129, directDiscountType: 'percent', directDiscountValue: 5, couponDiscountType: 'amount', couponDiscountValue: 3 },
                { id: 5, cost: 350, bottles: 1, targetPrice: 899, directDiscountType: 'percent', directDiscountValue: 20, couponDiscountType: 'amount', couponDiscountValue: 30 }
            ];
            
            // å¦‚æœå½“å‰æ²¡æœ‰SKUï¼Œæ¸…ç©ºç°æœ‰SKU
            if (skuList.length === 0) {
                skuList = [];
            }
            
            // è·å–æ–°çš„èµ·å§‹ID
            const startId = skuList.length > 0 ? Math.max(...skuList.map(sku => sku.id)) + 1 : 1;
            
            sampleSKUs.forEach((sku, index) => {
                skuList.push({
                    id: startId + index,
                    cost: sku.cost,
                    bottles: sku.bottles,
                    targetPrice: sku.targetPrice,
                    directDiscountType: sku.directDiscountType,
                    directDiscountValue: sku.directDiscountValue,
                    couponDiscountType: sku.couponDiscountType,
                    couponDiscountValue: sku.couponDiscountValue,
                    directDiscount: 0,
                    couponAmount: 0,
                    finalPrice: 0,
                    unitPrice: 0,
                    grossProfit: 0,
                    grossMargin: 0,
                    costMargin: 0,
                    netProfit: 0,
                    netMargin: 0,
                    directDiscountPreview: 0,
                    couponDiscountPreview: 0,
                    priceAfterDirect: 0,
                    priceAfterAll: 0,
                    createdAt: new Date().toISOString(),
                    selected: false
                });
            });
            
            updateSKUTable();
            // éšè—ç©ºçŠ¶æ€æç¤º
            document.getElementById('emptyState').style.display = 'none';
            showNotification('å·²æ·»åŠ 5ä¸ªç¤ºä¾‹SKUæ•°æ®ï¼Œè¯·ç‚¹å‡»"æ‰¹é‡è®¡ç®—"æŒ‰é’®è¿›è¡Œè®¡ç®—', 'success');
            
            // æ›´æ–°æˆæœ¬é¢„è§ˆï¼ˆå› ä¸ºå‚è€ƒå”®ä»·å¯èƒ½å˜åŒ–ï¼‰
            updateCostPreview();
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveToLocalStorage();
        }
        
        // æ·»åŠ SKU
        function addSKU() {
            saveStateToUndoStack();
            
            const newId = skuList.length > 0 ? Math.max(...skuList.map(sku => sku.id)) + 1 : 1;
            skuList.push({
                id: newId,
                cost: 0,
                bottles: 1, // æ¯SKUç“¶æ•°ï¼Œé»˜è®¤ä¸º1
                targetPrice: 0,
                directDiscountType: 'percent',
                directDiscountValue: 0,
                couponDiscountType: 'amount', // é»˜è®¤ä¼˜æƒ åˆ¸ç±»å‹ä¸ºå…ƒ
                couponDiscountValue: 0,
                directDiscount: 0,
                couponAmount: 0,
                finalPrice: 0,
                unitPrice: 0, // æ¯ç“¶å•ä»·
                grossProfit: 0,
                grossMargin: 0,
                costMargin: 0,
                netProfit: 0,
                netMargin: 0,
                directDiscountPreview: 0,
                couponDiscountPreview: 0,
                priceAfterDirect: 0,
                priceAfterAll: 0,
                createdAt: new Date().toISOString(),
                selected: false
            });
            
            updateSKUTable();
            // éšè—ç©ºçŠ¶æ€æç¤º
            document.getElementById('emptyState').style.display = 'none';
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveToLocalStorage();
        }
        
        // ç§»é™¤SKU
        function removeSKU(id) {
            saveStateToUndoStack();
            
            skuList = skuList.filter(sku => sku.id !== id);
            selectedSKUs.delete(id);
            updateSKUTable();
            
            // å¦‚æœæ²¡æœ‰SKUäº†ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€æç¤º
            if (skuList.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
            }
            
            // æ›´æ–°æˆæœ¬é¢„è§ˆ
            updateCostPreview();
            
            // æ›´æ–°é€‰ä¸­è®¡æ•°
            updateSelectedCount();
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveToLocalStorage();
        }
        
        // æ›´æ–°SKUè¡¨æ ¼
        function updateSKUTable() {
            const tbody = document.getElementById('skuTableBody');
            tbody.innerHTML = '';
            
            skuList.forEach((sku, index) => {
                // è®¡ç®—æŠ˜æ‰£é¢„è§ˆ
                updateDiscountPreview(sku);
                
                const row = document.createElement('tr');
                row.className = 'sku-row';
                row.setAttribute('data-id', sku.id);
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="sku-checkbox" data-id="${sku.id}" ${sku.selected ? 'checked' : ''}>
                    </td>
                    <td>${index + 1}</td>
                    <td class="table-cell-input">
                        <input type="number" class="sku-cost" value="${sku.cost || ''}" min="0" step="0.01" data-id="${sku.id}" placeholder="æˆæœ¬ä»·">
                        <span class="enter-hint">Enter</span>
                    </td>
                    <td class="table-cell-input">
                        <input type="number" class="sku-bottles bottles-input" value="${sku.bottles || 1}" min="1" step="1" data-id="${sku.id}" placeholder="ç“¶æ•°">
                        <span class="enter-hint">Enter</span>
                    </td>
                    <td class="table-cell-input">
                        <input type="number" class="sku-target-price" value="${sku.targetPrice || ''}" min="0" step="0.01" data-id="${sku.id}" placeholder="å¯¹æ ‡åŒè¡Œ">
                        <span class="enter-hint">Enter</span>
                    </td>
                    <td>
                        <div class="discount-input-group">
                            <div class="discount-type" data-id="${sku.id}" data-type="direct">
                                <button class="type-btn ${sku.directDiscountType === 'percent' ? 'active' : ''}" data-type="percent">%</button>
                                <button class="type-btn ${sku.directDiscountType === 'amount' ? 'active' : ''}" data-type="amount">å…ƒ</button>
                            </div>
                            <div class="table-cell-input">
                                <input type="number" class="sku-direct-discount-value" value="${sku.directDiscountValue || ''}" min="0" step="0.1" data-id="${sku.id}" placeholder="ç›´é™å€¼">
                                <span class="enter-hint">Enter</span>
                            </div>
                        </div>
                        <div class="discount-preview" data-id="${sku.id}" data-type="direct">
                            <div class="discount-preview-row">
                                <span class="discount-preview-label">å•å“ç›´é™ï¼š</span>
                                <span class="discount-preview-value ${getDiscountAmountColor(sku.directDiscountPreview, sku.targetPrice, 'direct')}" id="directPreviewAmount_${sku.id}">${sku.targetPrice > 0 ? sku.directDiscountPreview.toFixed(2) + 'å…ƒ' : 'éœ€è¾“å…¥å”®ä»·'}</span>
                            </div>
                            <div class="discount-preview-row">
                                <span class="discount-preview-label">ç›´é™åä»·æ ¼ï¼š</span>
                                <span class="discount-preview-value primary" id="priceAfterDirect_${sku.id}">${sku.targetPrice > 0 ? sku.priceAfterDirect.toFixed(2) + 'å…ƒ' : '-'}</span>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="discount-input-group">
                            <div class="discount-type" data-id="${sku.id}" data-type="coupon">
                                <button class="type-btn ${sku.couponDiscountType === 'percent' ? 'active' : ''}" data-type="percent">%</button>
                                <button class="type-btn ${sku.couponDiscountType === 'amount' ? 'active' : ''}" data-type="amount">å…ƒ</button>
                            </div>
                            <div class="table-cell-input">
                                <input type="number" class="sku-coupon-discount-value" value="${sku.couponDiscountValue || ''}" min="0" step="0.1" data-id="${sku.id}" placeholder="ä¼˜æƒ åˆ¸å€¼">
                                <span class="enter-hint">Enter</span>
                            </div>
                        </div>
                        <div class="discount-preview" data-id="${sku.id}" data-type="coupon">
                            <div class="discount-preview-row">
                                <span class="discount-preview-label">ä¼˜æƒ åˆ¸ï¼š</span>
                                <span class="discount-preview-value ${getDiscountAmountColor(sku.couponDiscountPreview, sku.priceAfterDirect, 'coupon')}" id="couponPreviewAmount_${sku.id}">${sku.targetPrice > 0 ? sku.couponDiscountPreview.toFixed(2) + 'å…ƒ' : 'éœ€è¾“å…¥å”®ä»·'}</span>
                            </div>
                            <div class="discount-preview-row discount-preview-total">
                                <span class="discount-preview-label">åˆè®¡ä¼˜æƒ ï¼š</span>
                                <span class="discount-preview-value warning" id="totalDiscount_${sku.id}">${sku.targetPrice > 0 ? (sku.directDiscountPreview + sku.couponDiscountPreview).toFixed(2) + 'å…ƒ' : '-'}</span>
                            </div>
                        </div>
                    </td>
                    <td class="sku-final-price ${sku.finalPrice > 0 ? 'profit-positive' : ''}">${sku.finalPrice > 0 ? sku.finalPrice.toFixed(2) : '-'}</td>
                    <td class="sku-unit-price ${sku.unitPrice > 0 ? 'profit-positive' : ''}">${sku.unitPrice > 0 ? sku.unitPrice.toFixed(2) : '-'}</td>
                    <td class="sku-gross-profit ${getProfitColor(sku.grossProfit)}">${sku.grossProfit > 0 ? sku.grossProfit.toFixed(2) : '-'}</td>
                    <td class="sku-gross-margin ${getMarginColor(sku.grossMargin)}">${sku.grossMargin > 0 ? sku.grossMargin.toFixed(1) + '%' : '-'}</td>
                    <td class="sku-cost-margin ${getCostMarginColor(sku.costMargin)}">${sku.costMargin > 0 ? sku.costMargin.toFixed(1) + '%' : '-'}</td>
                    <td class="sku-net-profit ${getProfitColor(sku.netProfit)}">${sku.netProfit > 0 ? sku.netProfit.toFixed(2) : '-'}</td>
                    <td class="sku-net-margin ${getMarginColor(sku.netMargin)}">${sku.netMargin > 0 ? sku.netMargin.toFixed(1) + '%' : '-'}</td>
                    <td>
                        <div class="sku-actions">
                            <button class="sku-btn calc" data-id="${sku.id}">è®¡ç®—</button>
                            <button class="sku-btn remove" data-id="${sku.id}">åˆ é™¤</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // æ›´æ–°SKUè®¡æ•°
            document.getElementById('skuCount').textContent = skuList.length;
            
            // è®¡ç®—å·²è®¡ç®—SKUæ•°é‡
            const calculatedCount = skuList.filter(sku => sku.finalPrice > 0 && sku.cost > 0).length;
            document.getElementById('calculatedCount').textContent = calculatedCount;
            
            // æ˜¾ç¤º/éšè—ç»Ÿè®¡æ•°æ®æ 
            if (skuList.length > 0) {
                document.getElementById('statsBar').style.display = 'flex';
                document.getElementById('statsTotalSKU').textContent = skuList.length;
                document.getElementById('statsCalculated').textContent = calculatedCount;
            } else {
                document.getElementById('statsBar').style.display = 'none';
            }
            
            // ç»‘å®šSKUè¡Œå†…äº‹ä»¶
            bindSKURowEvents();
        }
        
        // è®¡ç®—æŠ˜æ‰£é¢„è§ˆ
        function updateDiscountPreview(sku) {
            if (!sku.targetPrice || sku.targetPrice <= 0) {
                sku.directDiscountPreview = 0;
                sku.couponDiscountPreview = 0;
                sku.priceAfterDirect = 0;
                sku.priceAfterAll = 0;
                return;
            }
            
            // è®¡ç®—å•å“ç›´é™é‡‘é¢
            if (sku.directDiscountType === 'percent') {
                sku.directDiscountPreview = sku.targetPrice * (sku.directDiscountValue / 100);
            } else {
                sku.directDiscountPreview = parseFloat(sku.directDiscountValue) || 0;
            }
            
            // è®¡ç®—ç›´é™åä»·æ ¼
            sku.priceAfterDirect = sku.targetPrice - sku.directDiscountPreview;
            if (sku.priceAfterDirect < 0) sku.priceAfterDirect = 0;
            
            // è®¡ç®—ä¼˜æƒ åˆ¸é‡‘é¢
            if (sku.couponDiscountType === 'percent') {
                sku.couponDiscountPreview = sku.priceAfterDirect * (sku.couponDiscountValue / 100);
            } else {
                sku.couponDiscountPreview = parseFloat(sku.couponDiscountValue) || 0;
            }
            
            // è®¡ç®—åˆè®¡åä»·æ ¼
            sku.priceAfterAll = sku.priceAfterDirect - sku.couponDiscountPreview;
            if (sku.priceAfterAll < 0) sku.priceAfterAll = 0;
        }
        
        // æ›´æ–°æŠ˜æ‰£é¢„è§ˆæ˜¾ç¤º
        function updateDiscountPreviewDisplay(id) {
            const sku = skuList.find(s => s.id === id);
            if (!sku) return;
            
            // æ›´æ–°æŠ˜æ‰£é¢„è§ˆæ•°æ®
            updateDiscountPreview(sku);
            
            // æ›´æ–°æ˜¾ç¤º - ä½¿ç”¨æ›´é«˜æ•ˆçš„æ–¹å¼
            requestAnimationFrame(() => {
                const directPreviewElement = document.getElementById(`directPreviewAmount_${id}`);
                const priceAfterDirectElement = document.getElementById(`priceAfterDirect_${id}`);
                const couponPreviewElement = document.getElementById(`couponPreviewAmount_${id}`);
                const totalDiscountElement = document.getElementById(`totalDiscount_${id}`);
                
                if (directPreviewElement && sku.targetPrice > 0) {
                    directPreviewElement.textContent = sku.directDiscountPreview.toFixed(2) + 'å…ƒ';
                    directPreviewElement.className = `discount-preview-value ${getDiscountAmountColor(sku.directDiscountPreview, sku.targetPrice, 'direct')}`;
                } else if (directPreviewElement) {
                    directPreviewElement.textContent = 'éœ€è¾“å…¥å”®ä»·';
                    directPreviewElement.className = 'discount-preview-value';
                }
                
                if (priceAfterDirectElement && sku.targetPrice > 0) {
                    priceAfterDirectElement.textContent = sku.priceAfterDirect.toFixed(2) + 'å…ƒ';
                } else if (priceAfterDirectElement) {
                    priceAfterDirectElement.textContent = '-';
                }
                
                if (couponPreviewElement && sku.targetPrice > 0) {
                    couponPreviewElement.textContent = sku.couponDiscountPreview.toFixed(2) + 'å…ƒ';
                    couponPreviewElement.className = `discount-preview-value ${getDiscountAmountColor(sku.couponDiscountPreview, sku.priceAfterDirect, 'coupon')}`;
                } else if (couponPreviewElement) {
                    couponPreviewElement.textContent = 'éœ€è¾“å…¥å”®ä»·';
                    couponPreviewElement.className = 'discount-preview-value';
                }
                
                if (totalDiscountElement && sku.targetPrice > 0) {
                    const totalDiscount = sku.directDiscountPreview + sku.couponDiscountPreview;
                    totalDiscountElement.textContent = totalDiscount.toFixed(2) + 'å…ƒ';
                    
                    // æ ¹æ®æ€»æŠ˜æ‰£æ¯”ä¾‹æ·»åŠ é¢œè‰²æç¤º
                    const discountRate = (totalDiscount / sku.targetPrice) * 100;
                    totalDiscountElement.className = `discount-preview-value ${getTotalDiscountColor(discountRate)}`;
                } else if (totalDiscountElement) {
                    totalDiscountElement.textContent = '-';
                    totalDiscountElement.className = 'discount-preview-value';
                }
            });
        }
        
        // è·å–æŠ˜æ‰£é‡‘é¢é¢œè‰²
        function getDiscountAmountColor(discountAmount, basePrice, discountType) {
            if (!basePrice || basePrice <= 0) return '';
            
            const discountRate = (discountAmount / basePrice) * 100;
            
            if (discountType === 'direct') {
                // å•å“ç›´é™é¢œè‰²åˆ¤æ–­
                if (discountRate > 30) return 'danger'; // è¶…è¿‡30%é£é™©é«˜
                if (discountRate > 20) return 'warning'; // 20-30%éœ€è¦è°¨æ…
                if (discountRate > 10) return ''; // 10-20%æ­£å¸¸
                return 'primary'; // 10%ä»¥å†…æ¯”è¾ƒå®‰å…¨
            } else {
                // ä¼˜æƒ åˆ¸é¢œè‰²åˆ¤æ–­
                if (discountRate > 15) return 'danger'; // è¶…è¿‡15%é£é™©é«˜
                if (discountRate > 10) return 'warning'; // 10-15%éœ€è¦è°¨æ…
                if (discountRate > 5) return ''; // 5-10%æ­£å¸¸
                return 'primary'; // 5%ä»¥å†…æ¯”è¾ƒå®‰å…¨
            }
        }
        
        // è·å–æ€»æŠ˜æ‰£é¢œè‰²
        function getTotalDiscountColor(discountRate) {
            if (discountRate > 40) return 'danger'; // è¶…è¿‡40%é£é™©æé«˜
            if (discountRate > 30) return 'warning'; // 30-40%é£é™©é«˜
            if (discountRate > 20) return ''; // 20-30%æ­£å¸¸ä¿ƒé”€
            return 'primary'; // 20%ä»¥å†…å®‰å…¨
        }
        
        // è·å–åˆ©æ¶¦é¢œè‰²ç±»
        function getProfitColor(profit) {
            if (profit > 100) return 'profit-high';
            if (profit > 50) return 'profit-medium';
            if (profit > 20) return 'profit-low';
            if (profit > 0) return 'profit-very-low';
            return 'profit-negative';
        }
        
        // è·å–åˆ©æ¶¦ç‡é¢œè‰²ç±»ï¼ˆå”®ä»·æ¯›åˆ©ç‡ï¼‰
        function getMarginColor(margin) {
            if (margin > 40) return 'profit-high';
            if (margin > 25) return 'profit-medium';
            if (margin > 15) return 'profit-low';
            if (margin > 0) return 'profit-very-low';
            return 'profit-negative';
        }
        
        // è·å–æˆæœ¬æ¯›åˆ©ç‡é¢œè‰²ç±»
        function getCostMarginColor(costMargin) {
            if (costMargin > 150) return 'profit-high'; // è¶…è¿‡150%è¶…é«˜åˆ©æ¶¦
            if (costMargin > 80) return 'profit-medium'; // 80-150%é«˜åˆ©æ¶¦
            if (costMargin > 40) return 'profit-low'; // 40-80%ä¸­ç­‰åˆ©æ¶¦
            if (costMargin > 20) return 'profit-very-low'; // 20-40%ä½åˆ©æ¶¦
            if (costMargin > 0) return 'profit-negative'; // 0-20%å¾®åˆ©
            return 'profit-negative'; // äºæŸ
        }
        
        // ç»‘å®šSKUè¡Œå†…äº‹ä»¶ - ä¼˜åŒ–ç‰ˆ
        function bindSKURowEvents() {
            // ä½¿ç”¨äº‹ä»¶å§”æ‰˜æé«˜æ€§èƒ½
            const tbody = document.getElementById('skuTableBody');
            
            // ç‚¹å‡»äº‹ä»¶å§”æ‰˜
            tbody.addEventListener('click', function(e) {
                const target = e.target;
                
                // è®¡ç®—æŒ‰é’®
                if (target.classList.contains('sku-btn') && target.classList.contains('calc')) {
                    const id = parseInt(target.getAttribute('data-id'));
                    updateSingleSKU(id);
                    e.stopPropagation();
                }
                
                // åˆ é™¤æŒ‰é’®
                if (target.classList.contains('sku-btn') && target.classList.contains('remove')) {
                    const id = parseInt(target.getAttribute('data-id'));
                    removeSKU(id);
                    e.stopPropagation();
                }
                
                // æŠ˜æ‰£ç±»å‹åˆ‡æ¢æŒ‰é’®
                if (target.classList.contains('type-btn')) {
                    const container = target.closest('.discount-type');
                    if (container) {
                        const id = parseInt(container.getAttribute('data-id'));
                        const type = container.getAttribute('data-type'); // 'direct' æˆ– 'coupon'
                        const discountType = target.getAttribute('data-type');
                        
                        const sku = skuList.find(s => s.id === id);
                        if (sku) {
                            if (type === 'direct') {
                                sku.directDiscountType = discountType;
                            } else {
                                sku.couponDiscountType = discountType;
                            }
                            
                            // æ›´æ–°æŒ‰é’®çŠ¶æ€
                            container.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
                            target.classList.add('active');
                            
                            // å®æ—¶æ›´æ–°æŠ˜æ‰£é¢„è§ˆ
                            updateDiscountPreviewDisplay(id);
                            
                            // ä¿å­˜çŠ¶æ€
                            saveStateToUndoStack();
                        }
                        e.stopPropagation();
                    }
                }
                
                // å¤é€‰æ¡†
                if (target.classList.contains('sku-checkbox')) {
                    const id = parseInt(target.getAttribute('data-id'));
                    if (target.checked) {
                        selectedSKUs.add(id);
                    } else {
                        selectedSKUs.delete(id);
                    }
                    updateSelectedCount();
                }
            });
            
            // è¾“å…¥äº‹ä»¶å§”æ‰˜
            tbody.addEventListener('input', debounce(function(e) {
                const target = e.target;
                if (!target.classList.contains('sku-cost') && 
                    !target.classList.contains('sku-bottles') &&
                    !target.classList.contains('sku-target-price') &&
                    !target.classList.contains('sku-direct-discount-value') &&
                    !target.classList.contains('sku-coupon-discount-value')) {
                    return;
                }
                
                const id = parseInt(target.getAttribute('data-id'));
                const sku = skuList.find(s => s.id === id);
                if (!sku) return;
                
                const value = target.value.trim();
                
                if (target.classList.contains('sku-cost')) {
                    sku.cost = parseFloat(value) || 0;
                    updateDiscountPreviewDisplay(id);
                } else if (target.classList.contains('sku-bottles')) {
                    sku.bottles = parseInt(value) || 1;
                    if (sku.bottles < 1) sku.bottles = 1;
                } else if (target.classList.contains('sku-target-price')) {
                    sku.targetPrice = parseFloat(value) || 0;
                    updateDiscountPreviewDisplay(id);
                } else if (target.classList.contains('sku-direct-discount-value')) {
                    sku.directDiscountValue = parseFloat(value) || 0;
                    updateDiscountPreviewDisplay(id);
                } else if (target.classList.contains('sku-coupon-discount-value')) {
                    sku.couponDiscountValue = parseFloat(value) || 0;
                    updateDiscountPreviewDisplay(id);
                }
                
                // ä¿å­˜çŠ¶æ€
                saveStateToUndoStack();
            }, 500));
            
            // é”®ç›˜äº‹ä»¶å§”æ‰˜
            tbody.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const target = e.target;
                    if (target.classList.contains('sku-cost') || 
                        target.classList.contains('sku-bottles') ||
                        target.classList.contains('sku-target-price') ||
                        target.classList.contains('sku-direct-discount-value') ||
                        target.classList.contains('sku-coupon-discount-value')) {
                        
                        const id = parseInt(target.getAttribute('data-id'));
                        
                        // æ›´æ–°æ•°æ®ï¼ˆç«‹å³æ›´æ–°ï¼Œä¸ç­‰å¾…é˜²æŠ–ï¼‰
                        const sku = skuList.find(s => s.id === id);
                        if (sku) {
                            const value = target.value.trim();
                            
                            if (target.classList.contains('sku-cost')) {
                                sku.cost = parseFloat(value) || 0;
                                updateDiscountPreviewDisplay(id);
                            } else if (target.classList.contains('sku-bottles')) {
                                sku.bottles = parseInt(value) || 1;
                                if (sku.bottles < 1) sku.bottles = 1;
                            } else if (target.classList.contains('sku-target-price')) {
                                sku.targetPrice = parseFloat(value) || 0;
                                updateDiscountPreviewDisplay(id);
                            } else if (target.classList.contains('sku-direct-discount-value')) {
                                sku.directDiscountValue = parseFloat(value) || 0;
                                updateDiscountPreviewDisplay(id);
                            } else if (target.classList.contains('sku-coupon-discount-value')) {
                                sku.couponDiscountValue = parseFloat(value) || 0;
                                updateDiscountPreviewDisplay(id);
                            }
                            
                            // ä¿å­˜çŠ¶æ€
                            saveStateToUndoStack();
                        }
                        
                        // æ‰§è¡Œè®¡ç®—
                        updateSingleSKU(id);
                        
                        // ç§»é™¤ç„¦ç‚¹ï¼Œéšè—å›è½¦æç¤º
                        target.blur();
                    }
                }
            });
        }
        
        // æ›´æ–°å•ä¸ªSKU
        function updateSingleSKU(id) {
            const sku = skuList.find(s => s.id === id);
            if (!sku) return;
            
            // è·å–æˆæœ¬å‚æ•°
            const platformFeePercent = parseFloat(document.getElementById('platformFee').value) / 100 || 0;
            const kolFeePercent = parseFloat(document.getElementById('kolFee').value) / 100 || 0;
            const returnRatePercent = parseFloat(document.getElementById('returnRate').value) / 100 || 0;
            const otherCost = parseFloat(document.getElementById('otherCost').value) || 0;
            
            // å¦‚æœæ²¡æœ‰ç›®æ ‡å”®ä»·ï¼Œåˆ™æ— æ³•è®¡ç®—æœ€ç»ˆå”®ä»·å’Œåˆ©æ¶¦
            if (sku.targetPrice <= 0) {
                // é‡ç½®æ•°æ®
                sku.finalPrice = 0;
                sku.unitPrice = 0;
                sku.grossProfit = 0;
                sku.grossMargin = 0;
                sku.costMargin = 0;
                sku.netProfit = 0;
                sku.netMargin = 0;
                sku.directDiscount = 0;
                sku.couponAmount = 0;
                
                // æ›´æ–°è¡¨æ ¼æ˜¾ç¤º
                updateSKUTable();
                showNotification('è¯·å…ˆå¡«å†™ç›®æ ‡å”®ä»·', 'warning');
                return;
            }
            
            // åŸºå‡†ä»·ä¸ºç›®æ ‡å”®ä»·
            const basePrice = sku.targetPrice;
            
            // è®¡ç®—å•å“ç›´é™é‡‘é¢
            let directDiscountAmount = 0;
            if (sku.directDiscountType === 'percent') {
                directDiscountAmount = basePrice * (sku.directDiscountValue / 100);
            } else {
                directDiscountAmount = sku.directDiscountValue;
            }
            
            // è®¡ç®—ä¼˜æƒ åˆ¸é‡‘é¢ï¼ˆåŸºäºå•å“ç›´é™åä»·æ ¼ï¼‰
            const priceAfterDirect = basePrice - directDiscountAmount;
            let couponAmount = 0;
            
            if (sku.couponDiscountType === 'percent') {
                couponAmount = priceAfterDirect * (sku.couponDiscountValue / 100);
            } else {
                couponAmount = sku.couponDiscountValue;
            }
            
            sku.directDiscount = directDiscountAmount;
            sku.couponAmount = couponAmount;
            
            // è®¡ç®—æœ€ç»ˆå”®ä»·
            sku.finalPrice = basePrice - directDiscountAmount - couponAmount;
            if (sku.finalPrice < 0) sku.finalPrice = 0;
            
            // è®¡ç®—æ¯ç“¶å•ä»·
            sku.unitPrice = sku.finalPrice / sku.bottles;
            if (sku.unitPrice < 0) sku.unitPrice = 0;
            
            // è®¡ç®—åˆ©æ¶¦ï¼ˆå¿…é¡»æœ‰æˆæœ¬ä»·ï¼‰
            if (sku.finalPrice > 0 && sku.cost > 0) {
                // è®¡ç®—æ¯›åˆ©æ¶¦
                sku.grossProfit = sku.finalPrice - sku.cost;
                
                // è®¡ç®—å”®ä»·æ¯›åˆ©ç‡ï¼š(å”®ä»·-æˆæœ¬)/å”®ä»·Ã—100%
                sku.grossMargin = sku.finalPrice > 0 ? (sku.grossProfit / sku.finalPrice) * 100 : 0;
                
                // è®¡ç®—æˆæœ¬æ¯›åˆ©ç‡ï¼š(å”®ä»·-æˆæœ¬)/æˆæœ¬Ã—100%
                sku.costMargin = sku.cost > 0 ? (sku.grossProfit / sku.cost) * 100 : 0;
                
                // è®¡ç®—å…¶ä»–æˆæœ¬
                const platformFee = sku.finalPrice * platformFeePercent;
                const kolFee = sku.finalPrice * kolFeePercent;
                const returnLoss = sku.finalPrice * returnRatePercent;
                const totalOtherCosts = platformFee + kolFee + returnLoss + otherCost;
                
                // è®¡ç®—å‡€åˆ©æ¶¦
                sku.netProfit = sku.grossProfit - totalOtherCosts;
                sku.netMargin = sku.finalPrice > 0 ? (sku.netProfit / sku.finalPrice) * 100 : 0;
            } else {
                sku.grossProfit = 0;
                sku.grossMargin = 0;
                sku.costMargin = 0;
                sku.netProfit = 0;
                sku.netMargin = 0;
            }
            
            // æ›´æ–°è¡¨æ ¼æ˜¾ç¤º
            updateSKUTable();
            
            // æ›´æ–°æˆæœ¬é¢„è§ˆï¼ˆå› ä¸ºå‚è€ƒå”®ä»·å¯èƒ½å˜åŒ–ï¼‰
            updateCostPreview();
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveToLocalStorage();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            if (sku.finalPrice > 0 && sku.cost > 0) {
                showNotification(`SKU #${sku.id} è®¡ç®—å®Œæˆï¼æœ€ç»ˆå”®ä»·ï¼šÂ¥${sku.finalPrice.toFixed(2)}ï¼Œæ¯ç“¶å•ä»·ï¼šÂ¥${sku.unitPrice.toFixed(2)}ï¼Œå”®ä»·æ¯›åˆ©ç‡ï¼š${sku.grossMargin.toFixed(1)}%`, 'success');
            }
        }
        
        // è®¡ç®—æ‰€æœ‰SKU
        function calculateAllSKUs() {
            let calculatedCount = 0;
            let missingTargetPriceCount = 0;
            let missingCostCount = 0;
            
            skuList.forEach(sku => {
                if (sku.targetPrice > 0 && sku.cost > 0) {
                    updateSingleSKU(sku.id);
                    calculatedCount++;
                } else {
                    if (sku.targetPrice <= 0) missingTargetPriceCount++;
                    if (sku.cost <= 0) missingCostCount++;
                }
            });
            
            if (calculatedCount > 0) {
                showNotification(`æˆåŠŸè®¡ç®— ${calculatedCount} ä¸ªSKU`, 'success');
                if (missingTargetPriceCount > 0 || missingCostCount > 0) {
                    const missingMsg = [];
                    if (missingTargetPriceCount > 0) missingMsg.push(`${missingTargetPriceCount}ä¸ªSKUç¼ºå°‘ç›®æ ‡å”®ä»·`);
                    if (missingCostCount > 0) missingMsg.push(`${missingCostCount}ä¸ªSKUç¼ºå°‘æˆæœ¬ä»·`);
                    showNotification(`${missingMsg.join('ï¼Œ')}ï¼Œæ— æ³•è®¡ç®—`, 'warning');
                }
                
                // æ›´æ–°æˆæœ¬é¢„è§ˆ
                updateCostPreview();
            } else {
                showNotification('è¯·å…ˆå¡«å†™SKUçš„æˆæœ¬ä»·å’Œç›®æ ‡å”®ä»·', 'warning');
            }
        }
        
        // åˆ‡æ¢æ‰¹é‡ç¼–è¾‘é¢æ¿
        function toggleBatchEditPanel() {
            const panel = document.getElementById('batchEditPanel');
            if (isBatchEditOpen) {
                panel.style.display = 'none';
                isBatchEditOpen = false;
            } else {
                if (selectedSKUs.size > 0) {
                    panel.style.display = 'block';
                    isBatchEditOpen = true;
                } else {
                    showNotification('è¯·å…ˆé€‰æ‹©è¦ç¼–è¾‘çš„SKU', 'warning');
                }
            }
        }
        
        // æ›´æ–°é€‰ä¸­è®¡æ•°
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedSKUs.size;
            
            // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
            const allCheckboxes = document.querySelectorAll('.sku-checkbox');
            const selectAllCheckbox = document.getElementById('selectAll');
            
            if (allCheckboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
                return;
            }
            
            const checkedCount = document.querySelectorAll('.sku-checkbox:checked').length;
            
            if (checkedCount === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCount === allCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }
        
        // åº”ç”¨æ‰¹é‡ç¼–è¾‘
        function applyBatchEdit() {
            if (selectedSKUs.size === 0) {
                showNotification('è¯·å…ˆé€‰æ‹©è¦ç¼–è¾‘çš„SKU', 'warning');
                return;
            }
            
            saveStateToUndoStack();
            
            const batchCost = parseFloat(document.getElementById('batchCost').value);
            const batchTargetPrice = parseFloat(document.getElementById('batchTargetPrice').value);
            const batchDirectDiscount = parseFloat(document.getElementById('batchDirectDiscount').value);
            const batchCouponDiscount = parseFloat(document.getElementById('batchCouponDiscount').value);
            
            let updatedCount = 0;
            
            selectedSKUs.forEach(id => {
                const sku = skuList.find(s => s.id === id);
                if (sku) {
                    if (!isNaN(batchCost) && batchCost >= 0) sku.cost = batchCost;
                    if (!isNaN(batchTargetPrice) && batchTargetPrice >= 0) sku.targetPrice = batchTargetPrice;
                    if (!isNaN(batchDirectDiscount) && batchDirectDiscount >= 0) sku.directDiscountValue = batchDirectDiscount;
                    if (!isNaN(batchCouponDiscount) && batchCouponDiscount >= 0) sku.couponDiscountValue = batchCouponDiscount;
                    
                    updatedCount++;
                    
                    // æ›´æ–°æŠ˜æ‰£é¢„è§ˆ
                    updateDiscountPreviewDisplay(id);
                }
            });
            
            if (updatedCount > 0) {
                updateSKUTable();
                showNotification(`å·²æ›´æ–° ${updatedCount} ä¸ªSKU`, 'success');
                saveToLocalStorage();
            }
        }
        
        // ä¿å­˜é¢„è®¾
        function savePreset() {
            const preset = {
                name: 'æˆæœ¬å‚æ•°é¢„è®¾',
                platformFee: parseFloat(document.getElementById('platformFee').value) || 5,
                kolFee: parseFloat(document.getElementById('kolFee').value) || 20,
                returnRate: parseFloat(document.getElementById('returnRate').value) || 5,
                otherCost: parseFloat(document.getElementById('otherCost').value) || 5,
                savedAt: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(preset, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `æˆæœ¬å‚æ•°é¢„è®¾_${new Date().getTime()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showNotification('æˆæœ¬å‚æ•°é¢„è®¾å·²ä¿å­˜', 'success');
        }
        
        // åŠ è½½é¢„è®¾
        function loadPreset() {
            document.getElementById('presetInput').click();
        }
        
        // å¤„ç†é¢„è®¾å¯¼å…¥
        function handlePresetImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const preset = JSON.parse(e.target.result);
                    
                    if (preset.platformFee !== undefined) document.getElementById('platformFee').value = preset.platformFee;
                    if (preset.kolFee !== undefined) document.getElementById('kolFee').value = preset.kolFee;
                    if (preset.returnRate !== undefined) document.getElementById('returnRate').value = preset.returnRate;
                    if (preset.otherCost !== undefined) document.getElementById('otherCost').value = preset.otherCost;
                    
                    updateCostPreview();
                    showNotification('æˆæœ¬å‚æ•°é¢„è®¾å·²åŠ è½½', 'success');
                } catch (error) {
                    showNotification('é¢„è®¾æ–‡ä»¶è§£æå¤±è´¥', 'error');
                }
            };
            reader.readAsText(file);
            
            // é‡ç½®æ–‡ä»¶è¾“å…¥
            e.target.value = '';
        }
        
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        function saveToLocalStorage() {
            try {
                const data = {
                    skuList: skuList,
                    costParams: {
                        platformFee: document.getElementById('platformFee').value,
                        kolFee: document.getElementById('kolFee').value,
                        returnRate: document.getElementById('returnRate').value,
                        otherCost: document.getElementById('otherCost').value
                    },
                    savedAt: new Date().toISOString()
                };
                
                localStorage.setItem('skuPricingToolData', JSON.stringify(data));
                return true;
            } catch (error) {
                console.error('ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', error);
                showNotification('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                return false;
            }
        }
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('skuPricingToolData');
                if (!savedData) return false;
                
                const data = JSON.parse(savedData);
                
                // åŠ è½½SKUæ•°æ®
                if (data.skuList && Array.isArray(data.skuList)) {
                    skuList = data.skuList;
                    // ç¡®ä¿æ¯ä¸ªSKUéƒ½æœ‰å¿…è¦çš„å­—æ®µ
                    skuList.forEach(sku => {
                        if (!sku.id) sku.id = Math.random().toString(36).substr(2, 9);
                        if (!sku.bottles) sku.bottles = 1;
                        if (!sku.selected) sku.selected = false;
                        if (!sku.unitPrice) sku.unitPrice = 0;
                        // ç¡®ä¿ä¼˜æƒ åˆ¸é»˜è®¤ç±»å‹ä¸ºamount
                        if (!sku.couponDiscountType) sku.couponDiscountType = 'amount';
                    });
                }
                
                // åŠ è½½æˆæœ¬å‚æ•°
                if (data.costParams) {
                    document.getElementById('platformFee').value = data.costParams.platformFee || 5;
                    document.getElementById('kolFee').value = data.costParams.kolFee || 20;
                    document.getElementById('returnRate').value = data.costParams.returnRate || 5;
                    document.getElementById('otherCost').value = data.costParams.otherCost || 5;
                }
                
                if (skuList.length > 0) {
                    updateSKUTable();
                    updateCostPreview();
                    showNotification('å·²åŠ è½½ä¸Šæ¬¡ä¿å­˜çš„æ•°æ®', 'success');
                }
                
                return true;
            } catch (error) {
                console.error('ä»æœ¬åœ°å­˜å‚¨åŠ è½½å¤±è´¥:', error);
                return false;
            }
        }
        
        // åº”ç”¨åˆ°æ‰€æœ‰SKU
        function applyToAllSKUs() {
            showNotification('æˆæœ¬å‚æ•°å·²åº”ç”¨åˆ°æ‰€æœ‰SKUçš„è®¡ç®—ä¸­', 'success');
        }
        
        // é‡ç½®é…ç½®
        function resetConfig() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æˆæœ¬å‚æ•°å—ï¼Ÿ')) {
                // é‡ç½®æˆæœ¬å‚æ•°ä¸ºé»˜è®¤å€¼
                document.getElementById('platformFee').value = 5;
                document.getElementById('kolFee').value = 20;
                document.getElementById('returnRate').value = 5;
                document.getElementById('otherCost').value = 5;
                
                // æ›´æ–°æˆæœ¬é¢„è§ˆ
                updateCostPreview();
                
                showNotification('æˆæœ¬å‚æ•°å·²é‡ç½®ä¸ºé»˜è®¤å€¼', 'success');
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                saveToLocalStorage();
            }
        }
        
        // å¯¼å‡ºSKUæ•°æ®
        function exportSKUData() {
            if (skuList.length === 0) {
                showNotification('æ²¡æœ‰SKUæ•°æ®å¯ä»¥å¯¼å‡º', 'error');
                return;
            }
            
            const validSKUs = skuList.filter(sku => sku.finalPrice > 0 && sku.cost > 0);
            
            if (validSKUs.length === 0) {
                showNotification('æ²¡æœ‰å·²è®¡ç®—çš„SKUæ•°æ®å¯ä»¥å¯¼å‡º', 'warning');
                return;
            }
            
            const exportData = {
                å¯¼å‡ºæ—¶é—´: new Date().toLocaleString(),
                SKUæ€»æ•°: skuList.length,
                å·²è®¡ç®—SKUæ•°: validSKUs.length,
                æˆæœ¬å‚æ•°: {
                    å¹³å°ä½£é‡‘æ¯”ä¾‹: document.getElementById('platformFee').value || '0' + '%',
                    è¾¾äººä½£é‡‘æ¯”ä¾‹: document.getElementById('kolFee').value || '0' + '%',
                    é€€è´§ç‡é¢„ä¼°: document.getElementById('returnRate').value || '0' + '%',
                    å…¶ä»–æˆæœ¬: document.getElementById('otherCost').value || '0' + 'å…ƒ'
                },
                SKUåˆ—è¡¨: validSKUs.map(sku => ({
                    SKUç¼–å·: sku.id,
                    å®é™…æˆæœ¬: sku.cost.toFixed(2) + 'å…ƒ',
                    æ¯SKUç“¶æ•°: sku.bottles,
                    ç›®æ ‡å”®ä»·: sku.targetPrice.toFixed(2) + 'å…ƒ',
                    å•å“ç›´é™ç±»å‹: sku.directDiscountType === 'percent' ? 'ç™¾åˆ†æ¯”' : 'å›ºå®šé‡‘é¢',
                    å•å“ç›´é™å€¼: sku.directDiscountValue + (sku.directDiscountType === 'percent' ? '%' : 'å…ƒ'),
                    å•å“ç›´é™é‡‘é¢: sku.directDiscount.toFixed(2) + 'å…ƒ',
                    ä¼˜æƒ åˆ¸ç±»å‹: sku.couponDiscountType === 'percent' ? 'ç™¾åˆ†æ¯”' : 'å›ºå®šé‡‘é¢',
                    ä¼˜æƒ åˆ¸å€¼: sku.couponDiscountValue + (sku.couponDiscountType === 'percent' ? '%' : 'å…ƒ'),
                    ä¼˜æƒ åˆ¸é‡‘é¢: sku.couponAmount.toFixed(2) + 'å…ƒ',
                    æœ€ç»ˆå”®ä»·: sku.finalPrice.toFixed(2) + 'å…ƒ',
                    æ¯ç“¶å•ä»·: sku.unitPrice.toFixed(2) + 'å…ƒ',
                    æ¯›åˆ©: sku.grossProfit.toFixed(2) + 'å…ƒ',
                    æ¯›åˆ©ç‡: sku.grossMargin.toFixed(1) + '%',
                    æˆæœ¬æ¯›åˆ©ç‡: sku.costMargin.toFixed(1) + '%',
                    å‡€åˆ©: sku.netProfit.toFixed(2) + 'å…ƒ',
                    å‡€åˆ©ç‡: sku.netMargin.toFixed(1) + '%'
                }))
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `SKUå®šä»·åˆ†æ_${new Date().getTime()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showNotification('SKUæ•°æ®å·²å¯¼å‡ºä¸ºJSONæ–‡ä»¶', 'success');
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
